# =============================================================================
# CI Test Values
# =============================================================================
# This file is used for testing the chart during CI. It exercises all features
# to ensure templates render correctly and produce valid Kubernetes manifests.
#
# DO NOT use this file in production. It's designed for testing purposes only.
# =============================================================================

global:
  labels:
    team: "platform"
    environment: "test"
  annotations:
    test-annotation: "ci-test"
  imagePullSecrets:
    enabled: true
    secrets:
      - docker-registry-secret
  deploymentStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

common:
  initContainers:
    - name: wait-for-db
      image: busybox:1.36
      command: ['sh', '-c', 'echo "Waiting for database..."']
    - name: migrations
      image: myapp:latest
      command: ['sh', '-c', 'echo "Running migrations..."']

  additionalContainers:
    - name: log-shipper
      image: fluent/fluent-bit:2.1
      resources:
        requests:
          cpu: "50m"
          memory: "64Mi"
        limits:
          cpu: "100m"
          memory: "128Mi"

  configMap:
    enabled: true
    name: "common-config"
    labels:
      config-type: "shared"
    data:
      RAILS_ENV: "production"
      LOG_LEVEL: "info"

  secret:
    enabled: true
    name: "common-secrets"
    stringData:
      API_KEY: "test-api-key"

  sealedSecret:
    enabled: true
    name: "common-sealed"
    encryptedData:
      DATABASE_PASSWORD: "AgBy3i4OJSWK+PiTySYZZA9rO43cGDnNTgE="

# -----------------------------------------------------------------------------
# Deployments
# -----------------------------------------------------------------------------
deployments:
  # Frontend deployment (FE only)
  frontend:
    enabled: true
    replicaCount: 2
    labels:
      tier: "frontend"
    image:
      repoTag: "nginx:1.25-alpine"
      pullPolicy: IfNotPresent
    ports:
      - name: http
        containerPort: 80
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"
    livenessProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 10
      periodSeconds: 10
    readinessProbe:
      enabled: true
      httpGet:
        path: /ready
        port: http
      initialDelaySeconds: 5
      periodSeconds: 5
    # Frontend doesn't need DB init containers
    useCommonInitContainers: false
    useCommonAdditionalContainers: true
    service:
      enabled: true
      type: ClusterIP
      port: 80
      targetPort: 80
    ingress:
      enabled: true
      className: "nginx"
      annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
      hosts:
        - host: "app.example.com"
          paths: "/"
      tls:
        - secretName: app-tls
          hosts:
            - app.example.com

  # Backend API (Puma)
  puma:
    enabled: true
    replicaCount: 3
    labels:
      tier: "backend"
    image:
      repoTag: "myapp:v1.2.3"
      pullPolicy: Always
    command: ["bundle", "exec", "puma"]
    args: ["-C", "config/puma.rb"]
    ports:
      - name: http
        containerPort: 3000
    env:
      - name: RAILS_ENV
        value: "production"
      - name: WEB_CONCURRENCY
        value: "2"
    resources:
      requests:
        cpu: "250m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"
    livenessProbe:
      enabled: true
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      enabled: true
      httpGet:
        path: /ready
        port: http
      initialDelaySeconds: 10
      periodSeconds: 5
    useCommonConfigMap: true
    useCommonSecret: true
    useCommonInitContainers: true
    useCommonAdditionalContainers: true
    service:
      enabled: true
      type: ClusterIP
      port: 80
      targetPort: 3000
    ingress:
      enabled: true
      className: "nginx"
      hosts:
        - host: "api.example.com"
          paths:
            - path: /
              pathType: Prefix
    configMap:
      enabled: true
      data:
        PUMA_WORKERS: "2"

  # Background worker (SolidQueue)
  solidq:
    enabled: true
    replicaCount: 2
    labels:
      tier: "worker"
    image:
      repoTag: "myapp:v1.2.3"
      pullPolicy: Always
    command: ["bundle", "exec", "solid_queue:start"]
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
    # Workers don't need probes (no HTTP endpoint)
    useCommonConfigMap: true
    useCommonSecret: true
    useCommonSealedSecret: true
    useCommonInitContainers: true
    # Exclude migrations for worker - runs separately
    excludeCommonInitContainers:
      - migrations
    useCommonAdditionalContainers: false
    # No service for workers
    service:
      enabled: false

  # .NET Console Service worker
  dotnet-worker:
    enabled: true
    replicaCount: 1
    labels:
      tier: "worker"
      framework: "dotnet"
    image:
      repoTag: "mcr.microsoft.com/dotnet/samples:aspnetapp"
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "500m"
        memory: "256Mi"
    # No common init containers or sidecars for .NET worker
    useCommonInitContainers: false
    useCommonAdditionalContainers: false
    # Deployment-specific init container
    initContainers:
      - name: config-setup
        image: busybox:1.36
        command: ['sh', '-c', 'echo "Setting up config..."']
    configMap:
      enabled: true
      data:
        DOTNET_ENVIRONMENT: "Production"
    service:
      enabled: false

# -----------------------------------------------------------------------------
# Extra Resources
# -----------------------------------------------------------------------------
extraConfigMaps:
  nginx-config:
    enabled: true
    labels:
      config-type: "nginx"
    data:
      nginx.conf: |
        server {
            listen 80;
            location / {
                proxy_pass http://frontend;
            }
        }

extraSecrets:
  external-api-keys:
    enabled: true
    type: "Opaque"
    stringData:
      STRIPE_KEY: "sk_test_xxx"
      TWILIO_SID: "AC_test_xxx"

extraSealedSecrets:
  database-credentials:
    enabled: true
    type: "Opaque"
    encryptedData:
      DB_PASSWORD: "AgBy3i4OJSWK+PiTySYZZA9rO43cGDnNTgE="
      DB_HOST: "AgBy3i4OJSWK+PiTySYZZA9rO43cGDnNTgE="

extraIngresses:
  combined-ingress:
    enabled: true
    className: "nginx"
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    backend:
      serviceName: "frontend"
      servicePort: 80
    hosts:
      - host: "www.example.com"
        paths: "/"
    tls:
      - secretName: www-tls
        hosts:
          - www.example.com
